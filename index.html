<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Trivia Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- HOW TO ADD QUESTIONS ---
        1. Log in to your Supabase project.
        2. Go to the "Table Editor" on the left menu.
        3. Click on the "questions" table.
        4. Click the green "+ Insert row" button.
        5. Fill in the fields:
           - question_text: The question you want to ask.
           - options: A list of 4 answers in this exact format: ["Answer A", "Answer B", "Answer C", "Answer D"]
           - correct_answer_index: The number of the correct answer. The first answer is 0, the second is 1, third is 2, fourth is 3.
        6. Click "Save". Your new question is now in the game!
        */

        :root {
            --primary-blue: #3B82F6;
            --light-blue: #EFF6FF;
            --dark-blue: #1E40AF;
            --text-white: #FFFFFF;
            --text-dark: #1F2937;
            --green: #10B981;
            --red: #EF4444;
            --grey: #9CA3AF;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-blue);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .card {
            background-color: var(--text-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .game-card {
            background-color: var(--primary-blue);
            color: var(--text-white);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        p {
            margin-bottom: 20px;
            color: var(--grey);
        }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background-color: var(--primary-blue);
            color: var(--text-white);
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--dark-blue);
        }
        
        .btn-secondary {
            background-color: #D1D5DB;
            color: var(--text-dark);
        }
        
        .btn-secondary:hover {
            background-color: #9CA3AF;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 2px solid #D1D5DB;
            font-size: 1.1rem;
            text-align: center;
        }

        #game-code-display {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 5px;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--light-blue);
            border-radius: 12px;
            color: var(--primary-blue);
        }
        
        .players-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .player-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .player-avatar img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--grey);
        }
        
        .player-avatar.current-player img {
            border-color: var(--green);
            box-shadow: 0 0 15px var(--green);
        }

        .player-name {
            font-weight: 600;
        }

        .score-badge {
            background-color: var(--primary-blue);
            color: var(--text-white);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #question-counter, #timer {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        #question-text {
            font-size: 1.8rem;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .answer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .answer-btn {
            background-color: var(--light-blue);
            color: var(--text-dark);
            padding: 20px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .answer-btn.selected {
            background-color: var(--dark-blue);
            color: var(--text-white);
        }
        
        .answer-btn.correct {
            background-color: var(--green);
            color: var(--text-white);
        }
        
        .answer-btn.incorrect {
            background-color: var(--red);
            color: var(--text-white);
        }
        
        .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #chat-section {
            margin-top: 20px;
        }
        #chat-box {
            height: 100px;
            overflow-y: scroll;
            background-color: var(--light-blue);
            padding: 10px;
            border-radius: 12px;
            text-align: left;
            margin-bottom: 10px;
        }
        #chat-box p {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--text-dark);
        }
        #chat-box strong {
            color: var(--primary-blue);
        }
        #chat-form {
            display: flex;
            gap: 10px;
        }

        #leaderboard table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #leaderboard th, #leaderboard td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #leaderboard th {
            background-color: var(--light-blue);
        }

        #user-profile-info img {
             width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 1000;
        }
        
        #loading-overlay.active {
            display: flex;
        }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <p>Loading...</p>
    </div>

    <div class="container">
        <!-- AUTHENTICATION SCREEN -->
        <div id="auth-screen" class="screen active">
            <div class="card">
                <h1>Trivia Game</h1>
                <p>Log in with Google to start playing with your friends!</p>
                <button id="login-btn" class="btn">Login with Google</button>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="screen">
             <div id="user-profile-info" class="card">
                <img id="user-avatar" src="" alt="User Avatar">
                <h2 id="user-name">Welcome!</h2>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
            <div class="card">
                <h2>Play Now</h2>
                <button id="create-game-btn" class="btn">Create Game</button>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <input type="text" id="join-code-input" class="input-field" placeholder="Enter 6-Digit Code">
                <button id="join-game-btn" class="btn">Join Game</button>
            </div>
            <div id="leaderboard" class="card">
                <h2>Leaderboard</h2>
                <p>(Top 5 players by wins)</p>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Wins</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Rows will be added by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- WAITING ROOM SCREEN -->
        <div id="waiting-room-screen" class="screen">
            <div class="card">
                <h2>Waiting for Players...</h2>
                <p>Share this code with your friends:</p>
                <div id="game-code-display"></div>
                <div id="waiting-room-players" class="players-list">
                    <!-- Player avatars will be added by JavaScript -->
                </div>
                <button id="start-game-btn" class="btn" style="margin-top: 20px; display: none;">Start Game</button>
                <button id="leave-game-btn" class="btn btn-secondary" style="margin-top: 10px;">Leave Game</button>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="card game-card">
                <div id="game-header">
                    <div id="question-counter">Q 1/10</div>
                    <div id="settings-btn" style="cursor: pointer;">⚙️</div>
                </div>
                <h2 id="question-text">Who invented cars?</h2>
                <div id="timer-container" style="margin-top: 15px; font-size: 2rem; font-weight: 700;">
                    <span id="timer">10</span>
                </div>
                <div class="answer-options" id="answer-options">
                    <button class="answer-btn" data-index="0">A) Karl Benz</button>
                    <button class="answer-btn" data-index="1">B) Henry Ford</button>
                    <button class="answer-btn" data-index="2">C) Carl Benz</button>
                    <button class="answer-btn" data-index="3">D) Elon Musk</button>
                </div>
            </div>

            <div id="game-players-scores" class="players-list" style="margin-bottom: 20px;">
                <!-- Player scores will be updated by JavaScript -->
            </div>

            <div id="chat-section" class="card">
                <div id="chat-box"></div>
                <form id="chat-form">
                    <input type="text" id="chat-input" class="input-field" placeholder="Type a message...">
                    <button type="submit" class="btn">Send</button>
                </form>
            </div>
        </div>

        <!-- POST-GAME SCREEN -->
        <div id="post-game-screen" class="screen">
            <div class="card">
                <h1 id="winner-message">Esther Wins!</h1>
                <h2>Final Scores</h2>
                <div id="final-scores" class="players-list" style="flex-direction: column;">
                    <!-- Final scores will be added by JavaScript -->
                </div>
                <button id="back-to-lobby-btn" class="btn" style="margin-top: 20px;">Back to Lobby</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CLIENT SETUP ---
        // Replace with your actual Supabase URL and Anon Key
        const SUPABASE_URL = 'https://kldsmwvljwnosjmvehoq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsZHNtd3Zsandub3NqbXZlaG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTA3MDYsImV4cCI6MjA3NTE4NjcwNn0.MR28bfvXNmg6RRKFXNxyO2abJVIvgkNoZ7Baib-AOEQ';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let currentGame = null;
        let gameSubscription = null;
        let chatSubscription = null;
        let players = [];
        let questions = [];
        let currentQuestionIndex = 0;
        let questionTimer;
        const QUESTIONS_PER_GAME = 10;
        const TIME_PER_QUESTION = 10;

        // --- UI ELEMENT REFERENCES ---
        const screens = document.querySelectorAll('.screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinCodeInput = document.getElementById('join-code-input');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        
        // --- UTILITY FUNCTIONS ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.toggle('active', screen.id === screenId);
            });
        }
        
        function showLoading(isLoading) {
            loadingOverlay.classList.toggle('active', isLoading);
        }

        // --- AUTHENTICATION ---
        async function checkUserSession() {
            const { data, error } = await db.auth.getSession();
            if (data.session) {
                currentUser = data.session.user;
                await handleUserProfile(currentUser);
                showScreen('lobby-screen');
                await fetchLeaderboard();
            } else {
                showScreen('auth-screen');
            }
        }

        async function handleUserProfile(user) {
            // Check if profile exists
            const { data: profile, error } = await db.from('profiles').select('*').eq('id', user.id).single();

            if (error && error.code === 'PGRST116') { // PGRST116 means no rows found
                // Create a new profile
                const { data: newProfile, error: insertError } = await db.from('profiles').insert({
                    id: user.id,
                    username: user.user_metadata.full_name || 'New Player',
                    avatar_url: user.user_metadata.avatar_url || 'https://i.pravatar.cc/150',
                    games_won: 0
                }).select().single();

                if (insertError) console.error('Error creating profile:', insertError);
            }
            updateLobbyUI(user);
        }

        function updateLobbyUI(user) {
            document.getElementById('user-avatar').src = user.user_metadata.avatar_url;
            document.getElementById('user-name').textContent = `Welcome, ${user.user_metadata.full_name}!`;
        }

        loginBtn.addEventListener('click', async () => {
            const { error } = await db.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) console.error('Error logging in:', error);
        });

        logoutBtn.addEventListener('click', async () => {
            await db.auth.signOut();
            currentUser = null;
            showScreen('auth-screen');
        });

        // --- LOBBY LOGIC ---
        createGameBtn.addEventListener('click', async () => {
            showLoading(true);
            const gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            const { data, error } = await db.from('games').insert({
                game_code: gameCode,
                host_id: currentUser.id,
                status: 'waiting'
            }).select().single();

            if (error) {
                console.error('Error creating game:', error);
                showLoading(false);
                return;
            }
            currentGame = data;
            await joinGame(currentGame.id);
            showLoading(false);
        });

        joinGameBtn.addEventListener('click', async () => {
            const code = joinCodeInput.value.trim().toUpperCase();
            if (code.length !== 6) {
                alert('Please enter a valid 6-digit game code.');
                return;
            }
            showLoading(true);
            const { data, error } = await db.from('games').select('*').eq('game_code', code).eq('status', 'waiting').single();

            if (error || !data) {
                alert('Game not found or has already started.');
                showLoading(false);
                return;
            }

            // Check if game is full
            const { count } = await db.from('players').select('*', { count: 'exact' }).eq('game_id', data.id);
            if (count >= 4) {
                 alert('This game is full!');
                 showLoading(false);
                 return;
            }

            currentGame = data;
            await joinGame(currentGame.id);
            showLoading(false);
        });

        async function joinGame(gameId) {
            const { error } = await db.from('players').insert({
                game_id: gameId,
                user_id: currentUser.id
            });

            if (error) {
                // Handle potential duplicate join
                if(error.code !== '23505') console.error('Error joining game:', error);
            }
            
            showScreen('waiting-room-screen');
            await setupWaitingRoom();
        }

        async function fetchLeaderboard() {
            const { data, error } = await db.from('profiles').select('username, games_won').order('games_won', { ascending: false }).limit(5);
            if (error) {
                console.error('Error fetching leaderboard:', error);
                return;
            }
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            data.forEach((player, index) => {
                const row = `<tr><td>${index + 1}</td><td>${player.username}</td><td>${player.games_won}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- WAITING ROOM LOGIC ---
        async function setupWaitingRoom() {
            document.getElementById('game-code-display').textContent = currentGame.game_code;
            
            // Show start button for host
            startGameBtn.style.display = (currentUser.id === currentGame.host_id) ? 'block' : 'none';
            
            await updatePlayerList();

            // Subscribe to player changes
            gameSubscription = db.channel(`game-${currentGame.id}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `game_id=eq.${currentGame.id}` }, payload => {
                    updatePlayerList();
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${currentGame.id}` }, payload => {
                    // Game has started!
                    if (payload.new.status === 'in_progress') {
                        currentGame = payload.new;
                        startGame();
                    }
                })
                .subscribe();
            
            chatSubscription = db.channel(`chat-${currentGame.id}`)
                 .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages', filter: `game_id=eq.${currentGame.id}` }, payload => {
                    displayChatMessage(payload.new);
                })
                .subscribe();

        }

        async function updatePlayerList() {
            const { data, error } = await db.from('players')
                .select(`*, profiles(username, avatar_url)`)
                .eq('game_id', currentGame.id);
            
            if (error) {
                console.error('Error fetching players:', error);
                return;
            }
            
            players = data;
            const playerListContainer = document.getElementById('waiting-room-players');
            playerListContainer.innerHTML = '';
            players.forEach(player => {
                const isCurrentUser = player.user_id === currentUser.id;
                const playerDiv = `
                    <div class="player-avatar ${isCurrentUser ? 'current-player' : ''}">
                        <img src="${player.profiles.avatar_url}" alt="Player Avatar">
                        <span class="player-name">${player.profiles.username}</span>
                    </div>
                `;
                playerListContainer.innerHTML += playerDiv;
            });
        }
        
        leaveGameBtn.addEventListener('click', async () => {
            if (gameSubscription) gameSubscription.unsubscribe();
            if (chatSubscription) chatSubscription.unsubscribe();
            await db.from('players').delete().match({ game_id: currentGame.id, user_id: currentUser.id });
            currentGame = null;
            players = [];
            showScreen('lobby-screen');
        });

        // --- GAME START ---
        startGameBtn.addEventListener('click', async () => {
             if (players.length < 1) { // Normally 2, but 1 for testing
                alert('You need at least 1 player to start.');
                return;
             }

            showLoading(true);
            // Fetch random questions
            const { data, error } = await db.rpc('get_random_questions', { limit_count: QUESTIONS_PER_GAME });
            
            if (error || !data || data.length === 0) {
                 console.error('Error fetching questions or not enough questions in DB:', error);
                 alert('Could not fetch questions. Make sure you have added them to the database!');
                 showLoading(false);
                 return;
            }

            const questionIds = data.map(q => q.id);
            
            // Update game to start
            await db.from('games').update({ 
                status: 'in_progress',
                question_ids: questionIds,
                current_question_index: 0
            }).eq('id', currentGame.id);
            showLoading(false);
        });

        function startGame() {
             if (gameSubscription) {
                gameSubscription.unsubscribe(); // Stop listening for player joins
                gameSubscription = null;
             }
             showScreen('game-screen');
             setupGameListeners();
             displayQuestion();
        }
        
        // --- IN-GAME LOGIC ---
        
        async function displayQuestion() {
            // Fetch all questions for this game session at once
            if (questions.length === 0) {
                const { data, error } = await db.from('questions').select('*').in('id', currentGame.question_ids);
                if(error) { console.error(error); return; }
                
                // Re-order them based on the shuffled question_ids
                questions = currentGame.question_ids.map(id => data.find(q => q.id === id));
            }

            const question = questions[currentQuestionIndex];
            if (!question) {
                endGame();
                return;
            }
            
            document.getElementById('question-counter').textContent = `Q ${currentQuestionIndex + 1}/${QUESTIONS_PER_GAME}`;
            document.getElementById('question-text').textContent = question.question_text;
            
            const answerButtons = document.querySelectorAll('.answer-btn');
            answerButtons.forEach((btn, index) => {
                btn.textContent = `${String.fromCharCode(65 + index)}) ${question.options[index]}`;
                btn.dataset.index = index;
                btn.disabled = false;
                btn.className = 'answer-btn'; // Reset classes
            });
            
            updateGamePlayerScores();
            startTimer();
        }

        function startTimer() {
            let timeLeft = TIME_PER_QUESTION;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            
            clearInterval(questionTimer);
            questionTimer = setInterval(async () => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(questionTimer);
                    await showResults();
                }
            }, 1000);
        }

        const answerOptionsContainer = document.getElementById('answer-options');
        answerOptionsContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('answer-btn')) {
                const selectedIndex = parseInt(e.target.dataset.index);
                document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
                e.target.classList.add('selected');
                
                // The first person to answer correctly wins the point.
                // We'll use a Supabase RPC to handle this atomically to avoid race conditions.
                await db.rpc('submit_answer', {
                    p_game_id: currentGame.id,
                    p_user_id: currentUser.id,
                    p_question_index: currentQuestionIndex,
                    p_is_correct: selectedIndex === questions[currentQuestionIndex].correct_answer_index
                });
            }
        });
        
        async function showResults() {
            clearInterval(questionTimer);
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            
            const correctAnswerIndex = questions[currentQuestionIndex].correct_answer_index;
            document.querySelector(`.answer-btn[data-index='${correctAnswerIndex}']`).classList.add('correct');
            
            // Fetch updated scores
            const { data, error } = await db.from('players').select(`*, profiles(username, avatar_url)`).eq('game_id', currentGame.id);
            if(error) console.error(error);
            else players = data;

            updateGamePlayerScores();
            
            // Wait a few seconds before the next question
            setTimeout(async () => {
                currentQuestionIndex++;
                // Only host updates the game state
                if (currentUser.id === currentGame.host_id) {
                    await db.from('games').update({ current_question_index: currentQuestionIndex }).eq('id', currentGame.id);
                }
            }, 3000);
        }

        function setupGameListeners() {
            gameSubscription = db.channel(`game-state-${currentGame.id}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${currentGame.id}` }, payload => {
                    // Another player progressed the game
                    if (payload.new.current_question_index > currentQuestionIndex) {
                        currentQuestionIndex = payload.new.current_question_index;
                        displayQuestion();
                    }
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'players', filter: `game_id=eq.${currentGame.id}`}, payload => {
                    // A score was updated
                    const updatedPlayer = players.find(p => p.user_id === payload.new.user_id);
                    if (updatedPlayer) {
                        updatedPlayer.score = payload.new.score;
                        updateGamePlayerScores();
                    }
                })
                .subscribe();
        }
        
        function updateGamePlayerScores() {
            const container = document.getElementById('game-players-scores');
            container.innerHTML = '';
            players.sort((a,b) => b.score - a.score).forEach(p => {
                 const isCurrentUser = p.user_id === currentUser.id;
                 container.innerHTML += `
                    <div class="player-avatar ${isCurrentUser ? 'current-player' : ''}">
                        <img src="${p.profiles.avatar_url}" alt="Avatar">
                        <span class="player-name" style="color: var(--text-dark);">${p.profiles.username}</span>
                        <div class="score-badge">Score: ${p.score}</div>
                    </div>
                 `;
            });
        }
        
        async function endGame() {
            if (gameSubscription) gameSubscription.unsubscribe();
            if (chatSubscription) chatSubscription.unsubscribe();
            
            players.sort((a,b) => b.score - a.score);
            const winner = players[0];

            document.getElementById('winner-message').textContent = `${winner.profiles.username} Wins!`;
            
            const finalScoresContainer = document.getElementById('final-scores');
            finalScoresContainer.innerHTML = '';
             players.forEach(p => {
                 finalScoresContainer.innerHTML += `
                    <div class="player-avatar" style="margin-bottom: 15px;">
                        <img src="${p.profiles.avatar_url}" alt="Avatar">
                        <span class="player-name" style="color: var(--text-dark);">${p.profiles.username} - Score: ${p.score}</span>
                    </div>
                 `;
            });

            // Host updates winner's profile
            if (currentUser.id === currentGame.host_id) {
                await db.rpc('increment_wins', { user_id_to_update: winner.user_id });
            }
            
            showScreen('post-game-screen');
        }

        backToLobbyBtn.addEventListener('click', () => {
            currentGame = null;
            players = [];
            questions = [];
            currentQuestionIndex = 0;
            showScreen('lobby-screen');
            fetchLeaderboard();
        });

        // --- CHAT LOGIC ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatBox = document.getElementById('chat-box');
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                await db.from('chat_messages').insert({
                    game_id: currentGame.id,
                    user_id: currentUser.id,
                    message: message
                });
                chatInput.value = '';
            }
        });
        
        async function displayChatMessage(chat) {
            // We need the username, which isn't in the payload. Let's find it in our players list.
            const sender = players.find(p => p.user_id === chat.user_id);
            const senderName = sender ? sender.profiles.username : 'A player';
            
            chatBox.innerHTML += `<p><strong>${senderName}:</strong> ${chat.message}</p>`;
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, we need a couple of functions in our database. Let's tell the user.
            alert("One-time setup: After clicking OK, go to your Supabase project -> SQL Editor -> \"New query\" and paste the SQL code from the game file's comments to enable all features. You only need to do this once, ever.");
            
            checkUserSession();
        });
        
        /*
        --- ONE-TIME DATABASE SETUP ---
        Go to your Supabase project -> SQL Editor -> "New query".
        Paste the entire block of code below and click "RUN".
        You only need to do this ONCE for your project.
        
        -- Function to get random questions
        create or replace function get_random_questions(limit_count int)
        returns table (id uuid, question_text text, options jsonb, correct_answer_index int) as $$
        begin
          return query
          select q.id, q.question_text, q.options, q.correct_answer_index
          from public.questions as q
          order by random()
          limit limit_count;
        end;
        $$ language plpgsql;

        -- Function to handle submitting an answer and awarding points to the first correct one
        create or replace function submit_answer(p_game_id uuid, p_user_id uuid, p_question_index int, p_is_correct boolean)
        returns void as $$
        declare
          v_winner_exists boolean;
        begin
          -- Check if anyone has already answered this question correctly in this game
          select exists (
            select 1 from public.players
            where game_id = p_game_id and last_correct_question_index = p_question_index
          ) into v_winner_exists;

          -- If no one has won this round yet and the answer is correct, award the point
          if not v_winner_exists and p_is_correct then
            update public.players
            set
              score = score + 1,
              last_correct_question_index = p_question_index
            where game_id = p_game_id and user_id = p_user_id;
          end if;
        end;
        $$ language plpgsql;
        
        -- Add a column to track the last won question to prevent multiple winners per round
        alter table public.players add column if not exists last_correct_question_index int default -1;
        
        -- Function to increment a user's win count
        create or replace function increment_wins(user_id_to_update uuid)
        returns void as $$
        begin
            update public.profiles
            set games_won = games_won + 1
            where id = user_id_to_update;
        end;
        $$ language plpgsql;
        
        */

    </script>
</body>
</html>
