<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hard Guess â€” Supabase Auth + Realtime</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg,#e6f6ff 0%,#dff6ff 100%); color:#02243a; }
    .font-orbitron { font-family: 'Orbitron', sans-serif; }
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); }
    .selected-ring { box-shadow: 0 0 0 6px rgba(34,197,94,0.16); border-color:#16a34a; }
    .answer-btn { transition: all .18s ease-in-out; }
    .answer-btn.correct { background:#16a34a; color:#000; }
    .answer-btn.incorrect { background:#ef4444; color:#000; }
    .screen { display:none; }
    .screen.active { display:flex; }
    .avatar-small { width:56px; height:56px; border-radius:9999px; }
    .avatar-ring { padding:6px; border-radius:9999px; display:inline-block; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

  <div id="app" class="w-full max-w-5xl">
    <!-- LOADING -->
    <div id="loading" class="screen active flex-col items-center space-y-3">
      <h1 class="text-4xl font-orbitron">HARD GUESS</h1>
      <p>Connecting to backend...</p>
    </div>

    <!-- AUTH -->
    <div id="auth-screen" class="screen flex-col items-center space-y-4">
      <h2 class="text-2xl font-orbitron">Sign in</h2>

      <div class="flex flex-col space-y-2">
        <button id="btn-google" class="px-6 py-2 bg-red-600 text-white rounded">Sign in with Google</button>
        <div class="flex items-center space-x-2">
          <input id="email-input" placeholder="Email for magic link" class="p-2 border rounded w-64">
          <button id="btn-email" class="px-4 py-2 bg-blue-600 text-white rounded">Send Link</button>
        </div>
        <p class="text-center">or</p>
        <button id="btn-anon" class="px-6 py-2 bg-gray-600 text-white rounded">Play as Guest</button>
      </div>
    </div>

    <!-- PROFILE SETUP (if new user) -->
    <div id="profile-screen" class="screen flex-col items-center space-y-4">
      <h2 class="text-2xl font-orbitron">Create profile</h2>
      <input id="profile-username" maxlength="18" placeholder="Choose a username" class="p-2 border rounded w-64">
      <input id="profile-avatar-file" type="file" accept="image/*" class="w-64">
      <div class="flex space-x-2">
        <button id="btn-save-profile" class="px-6 py-2 bg-green-600 text-white rounded">Save Profile</button>
      </div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-screen" class="screen flex-col items-center space-y-6">
      <div class="w-full flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div id="me-avatar" class="avatar-ring"><img id="me-avatar-img" class="avatar-small" src="" alt="avatar"></div>
          <div>
            <div id="me-username" class="font-bold"></div>
            <div id="me-email" class="text-sm text-gray-600"></div>
          </div>
        </div>
        <div>
          <button id="btn-logout" class="px-3 py-1 border rounded">Logout</button>
        </div>
      </div>

      <h1 class="text-5xl font-orbitron">HARD GUESS</h1>
      <div class="flex space-x-4">
        <button id="btn-create" class="px-8 py-3 bg-blue-600 text-white rounded">Create Game</button>
        <button id="btn-join" class="px-8 py-3 bg-indigo-600 text-white rounded">Join Game</button>
      </div>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="screen flex-col space-y-4">
      <div class="w-full flex justify-between items-center">
        <h2 class="text-2xl font-orbitron">Lobby</h2>
        <div class="flex space-x-2">
          <button id="btn-leave" class="px-4 py-2 bg-red-500 text-white rounded">Leave</button>
          <button id="btn-start" class="px-4 py-2 bg-green-600 text-white rounded" disabled>Start</button>
        </div>
      </div>

      <div class="glass p-4 rounded">
        <div class="text-sm">Game code (click to copy)</div>
        <div id="display-code" class="mt-2 font-orbitron text-2xl tracking-widest cursor-pointer">------</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass p-4 rounded">
          <h3 class="font-orbitron">Settings</h3>
          <label class="block mt-2">Time per question</label>
          <select id="time-select" class="p-2 border rounded mt-1 w-full">
            <option value="10">10s</option>
            <option value="15" selected>15s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
          <label class="block mt-2">Number of questions</label>
          <select id="num-select" class="p-2 border rounded mt-1 w-full">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
          </select>
        </div>

        <div class="glass p-4 rounded">
          <h3 class="font-orbitron">Players <span id="lobby-count"></span></h3>
          <div id="lobby-players" class="mt-2 space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- JOIN -->
    <div id="join-screen" class="screen flex-col items-center space-y-4">
      <h2 class="font-orbitron">Join Game</h2>
      <input id="join-code" maxlength="36" placeholder="Enter Game Code" class="p-2 border rounded w-64 text-center">
      <div class="flex space-x-2">
        <button id="join-back" class="px-4 py-2 border rounded">Back</button>
        <button id="join-go" class="px-4 py-2 bg-blue-600 text-white rounded">Join</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="game-screen" class="screen flex-col space-y-4">
      <div class="w-full flex justify-between items-center">
        <div id="q-counter" class="font-orbitron">Q: 0/0</div>
        <div class="flex items-center space-x-4">
          <div id="timer-display" class="text-2xl font-orbitron">15</div>
          <button id="btn-settings" class="p-2 bg-white rounded-full"><i data-lucide="settings"></i></button>
        </div>
      </div>

      <div class="glass p-6 rounded-2xl">
        <h2 id="question-text" class="text-2xl font-bold text-center">Loading...</h2>
      </div>

      <div id="answers" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

      <div id="players-row" class="grid grid-cols-4 gap-4 mt-4"></div>

      <div class="glass p-3 rounded">
        <div id="chat-box" class="h-28 overflow-y-auto mb-2"></div>
        <div class="flex">
          <input id="chat-text" placeholder="Say something..." class="flex-1 p-2 border rounded-l">
          <button id="chat-send" class="px-4 bg-blue-600 text-white rounded-r">Send</button>
        </div>
      </div>
    </div>

    <!-- GAME OVER -->
    <div id="over-screen" class="screen flex-col items-center space-y-4">
      <h2 class="text-4xl font-orbitron">GAME OVER</h2>
      <div id="winner-box" class="text-center"></div>
      <button id="back-menu" class="px-6 py-2 bg-blue-600 text-white rounded">Back to Menu</button>
    </div>
  </div>

  <!-- Supabase client + app logic -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // 1. SUPABASE CREDENTIALS
    const SUPABASE_URL = 'https://kldsmwvljwnosjmvehoq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsZHNtd3Zsandub3NqbXZlaG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTA3MDYsImV4cCI6MjA3NTE4NjcwNn0.MR28bfvXNmg6RRKFXNxyO2abJVIvgkNoZ7Baib-AOEQ';

    // 2. INITIALIZE SUPABASE CLIENT
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 3. START APP LOGIC
    
    // DOM refs
    const screens = {
      loading: document.getElementById('loading'),
      auth: document.getElementById('auth-screen'),
      profile: document.getElementById('profile-screen'),
      main: document.getElementById('main-screen'),
      lobby: document.getElementById('lobby-screen'),
      join: document.getElementById('join-screen'),
      game: document.getElementById('game-screen'),
      over: document.getElementById('over-screen')
    };

    const btnGoogle = document.getElementById('btn-google');
    const btnEmail = document.getElementById('btn-email');
    const emailInput = document.getElementById('email-input');
    const btnAnon = document.getElementById('btn-anon');

    const profileUsername = document.getElementById('profile-username');
    const profileAvatarFile = document.getElementById('profile-avatar-file');
    const btnSaveProfile = document.getElementById('btn-save-profile');

    const meAvatarImg = document.getElementById('me-avatar-img');
    const meUsername = document.getElementById('me-username');
    const meEmailEl = document.getElementById('me-email');
    const btnLogout = document.getElementById('btn-logout');

    const btnCreate = document.getElementById('btn-create');
    const btnJoin = document.getElementById('btn-join');

    const displayCode = document.getElementById('display-code');
    const timeSelect = document.getElementById('time-select');
    const numSelect = document.getElementById('num-select');
    const lobbyPlayers = document.getElementById('lobby-players');
    const lobbyCount = document.getElementById('lobby-count');
    const btnLeave = document.getElementById('btn-leave');
    const btnStart = document.getElementById('btn-start');

    const joinCodeInput = document.getElementById('join-code');
    const joinBack = document.getElementById('join-back');
    const joinGo = document.getElementById('join-go');

    const qCounter = document.getElementById('q-counter');
    const timerDisplay = document.getElementById('timer-display');
    const questionText = document.getElementById('question-text');
    const answersEl = document.getElementById('answers');
    const playersRow = document.getElementById('players-row');

    const chatBox = document.getElementById('chat-box');
    const chatText = document.getElementById('chat-text');
    const chatSend = document.getElementById('chat-send');

    const winnerBox = document.getElementById('winner-box');
    const backMenu = document.getElementById('back-menu');

    // App state
    let authUser = null;        // supabase auth user
    let profile = null;         // profiles row
    let currentGame = null;     // games row
    let players = [];           // players list for current game
    let gameChannels = [];      // Supabase realtime channels
    let hostTimer = null;

    // question bank (client): you may later move to server or DB
    const questionBank = [
      { question: "What is the capital of France?", answers:["Berlin","Madrid","Paris","Rome"], correct:2 },
      { question: "Which planet is known as the Red Planet?", answers:["Earth","Mars","Jupiter","Venus"], correct:1 },
      { question: "Who wrote 'Hamlet'?", answers:["Charles Dickens","William Shakespeare","Leo Tolstoy","Mark Twain"], correct:1 },
      { question: "What is the largest ocean on Earth?", answers:["Atlantic","Indian","Arctic","Pacific"], correct:3 },
      { question: "What is the chemical symbol for gold?", answers:["Au","Ag","Pb","Fe"], correct:0 },
      { question: "In which year did the Titanic sink?", answers:["1905","1912","1918","1923"], correct:1 },
      { question: "Who painted the Mona Lisa?", answers:["Vincent van Gogh","Pablo Picasso","Leonardo da Vinci","Claude Monet"], correct:2 },
      { question: "What is the speed of light?", answers:["300000 km/s","150000 km/s","500000 km/s","1000000 km/s"], correct:0 },
      { question: "Which is the smallest continent?", answers:["Asia","Australia","Antarctica","Europe"], correct:1 },
      { question: "How many continents are there?", answers:["5","6","7","8"], correct:2 }
    ];

    // -------------------------
    // UI helpers
    // -------------------------
    function show(screenName) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[screenName].classList.add('active');
    }

    // -------------------------
    // Auth & Profile
    // -------------------------
    async function fetchProfile(userId) {
      const { data, error } = await supabase.from('profiles').select('*').eq('id', userId).single();
      if (error && error.code === 'PGRST116') return null;
      if (error) console.error('fetchProfile', error);
      return data || null;
    }

    // --- FINALIZED AUTH BUTTONS ---

    btnGoogle.addEventListener('click', async () => {
      // This is the correct method for browser-based redirects.
      await supabase.auth.signInWithRedirect({ 
        provider: 'google', 
        options: { redirectTo: window.location.href } // Use the current page URL as the redirect target
      });
    });

    btnEmail.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email) return alert('Enter an email');
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) { alert('Failed to send magic link: ' + error.message); } else { alert('Magic link sent. Check your email.'); }
    });

    btnAnon.addEventListener('click', async () => {
      // Correct way to handle guest sign-ins.
      const { error } = await supabase.auth.signInAnonymously();
      if (error) {
          alert('Failed to sign in as guest: ' + error.message);
      }
    });

    // --- END FINALIZED AUTH BUTTONS ---


    // Save profile (runs after new auth user signs in and needs profile)
    btnSaveProfile.addEventListener('click', async () => {
      const username = profileUsername.value.trim();
      if (!username) return alert('Enter a username');
      if (!authUser) return alert('Auth not found');

      // upload avatar if provided
      let avatar_url = null;
      if (profileAvatarFile.files && profileAvatarFile.files[0]) {
        const file = profileAvatarFile.files[0];
        const ext = file.name.split('.').pop();
        const key = `avatars/${authUser.id}.${ext}`;
        const { data: uploadData, error: uploadErr } = await supabase.storage.from('avatars').upload(key, file, { upsert: true });
        if (uploadErr) { console.error('avatar upload', uploadErr); alert('Failed to upload avatar'); }
        else {
          const publicUrl = supabase.storage.from('avatars').getPublicUrl(key).data.publicUrl;
          avatar_url = publicUrl;
        }
      }
      
      const finalUsername = username || `Guest-${authUser.id.slice(0, 6)}`;

      const { data, error } = await supabase.from('profiles').insert([{ id: authUser.id, username: finalUsername, avatar_url }]).select().single();
      if (error) { console.error('create profile', error); alert('Failed to create profile: ' + error.message); return; }
      profile = data;
      populateMainProfile();
      show('main');
    });

    async function populateMainProfile() {
      meAvatarImg.src = profile.avatar_url || `https://placehold.co/64x64/0d0c22/ffffff?text=${profile.username.charAt(0)}`;
      meUsername.textContent = profile.username;
      const { data: u } = await supabase.auth.getUser();
      meEmailEl.textContent = u?.user?.email || 'Guest';
    }

    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      profile = null;
      authUser = null;
      show('auth');
    });

    // =================================================================
    // --- REFACTORED AND ROBUST STARTUP LOGIC ---
    // =================================================================

    // This single function handles all UI updates based on the user's session.
    async function handleUserSession(session) {
      authUser = session?.user ?? null;

      if (!authUser) {
        profile = null;
        show('auth');
        return;
      }

      const prof = await fetchProfile(authUser.id);

      if (!prof) {
        show('profile');
      } else {
        profile = prof;
        populateMainProfile();
        show('main');
      }
    }

    // 1. Set up a listener for any future auth changes (e.g., user logs out).
    supabase.auth.onAuthStateChange((event, session) => {
      // This listener handles events like SIGNED_IN, SIGNED_OUT, etc., after the initial load.
      if (event !== 'INITIAL_SESSION') {
        handleUserSession(session);
      }
    });

    // 2. Check for the session when the page loads. This is critical for the redirect.
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      await handleUserSession(session);
      lucide.createIcons();
    })();

    // -------------------------------------------------------------
    // --- GAME LOGIC (UNCHANGED) ---
    // -------------------------------------------------------------

    function makeGameCode() {
      return Math.random().toString(36).substring(2,8).toUpperCase();
    }

    async function createGame() {
      if (!profile) return alert('Please create a profile first');
      const code = makeGameCode();
      const settings = { timePerQuestion: parseInt(timeSelect.value,10), numQuestions: parseInt(numSelect.value,10) };
      const questions = shuffleArray([...questionBank]).slice(0, settings.numQuestions);
      const payload = { code, host_id: profile.id, settings, state: 'waiting', current_question: -1, timer_value: settings.timePerQuestion, questions };

      const { data, error } = await supabase.from('games').insert([payload]).select().single();
      if (error) { console.error('create game', error); return alert('Failed to create game'); }

      await supabase.from('players').insert([{ game_id: data.id, user_id: profile.id, score:0, is_host:true }]);
      currentGame = data;
      startListening(data.id);
      showLobby(data);
    }

    async function joinGameByCode(code) {
      const { data: g, error } = await supabase.from('games').select('*').eq('code', code.toUpperCase()).single();
      if (error || !g) { console.error('join', error); return alert('Game not found'); }
      await supabase.from('players').insert([{ game_id: g.id, user_id: profile.id, score:0 }]);
      currentGame = g;
      startListening(g.id);
      showLobby(g);
    }

    function startListening(gameId) {
      gameChannels.forEach(ch => ch.unsubscribe());
      gameChannels = [];

      const chGame = supabase.channel(`realtime-game-${gameId}`)
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, payload => {
          currentGame = payload.new;
          if (currentGame.state === 'waiting') showLobby(currentGame);
          else if (currentGame.state === 'in_progress' || currentGame.state === 'round_over') showGameScreen(currentGame);
          else if (currentGame.state === 'finished') showGameOver(currentGame);
        })
        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, () => {
          alert('Game was removed');
          leaveGame();
        })
        .subscribe();

      const chPlayers = supabase.channel(`realtime-players-${gameId}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `game_id=eq.${gameId}` }, payload => {
          fetchPlayers(gameId);
        })
        .subscribe();

      const chChat = supabase.channel(`realtime-chat-${gameId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat', filter: `game_id=eq.${gameId}` }, payload => {
          appendChat(payload.new.username, payload.new.text);
        }).subscribe();

      gameChannels.push(chGame, chPlayers, chChat);
      fetchPlayers(gameId);
      fetchGameRow(gameId);
      fetchChat(gameId);
    }

    async function fetchGameRow(gameId) {
      const { data } = await supabase.from('games').select('*').eq('id', gameId).single();
      currentGame = data;
      return data;
    }

    async function fetchPlayers(gameId) {
      const { data, error } = await supabase.from('players').select('*, profiles(username,avatar_url)').eq('game_id', gameId).order('joined_at', { ascending: true });
      if (error) { console.error('fetchPlayers',error); return; }
      players = data.map(p => ({
        id: p.id, user_id: p.user_id, username: p.profiles?.username || '', avatar: p.profiles?.avatar_url || '', score: p.score || 0, current_answer: p.answer, eliminated: p.eliminated
      }));
      renderLobbyPlayers();
      renderPlayersRow();
    }

    async function fetchChat(gameId) {
      const { data } = await supabase.from('chat').select('*').eq('game_id', gameId).order('timestamp', { ascending: true }).limit(200);
      chatBox.innerHTML = ''; // Clear chatbox on fetch
      if (data) data.forEach(m => appendChat(m.username, m.text));
    }

    function showLobby(gameRow) {
      currentGame = gameRow;
      displayCode.textContent = currentGame.code || currentGame.id.slice(0,6).toUpperCase();
      lobbyCount.textContent = `(${players.length || 0})`;
      show('lobby');
      if (currentGame && profile) {
        btnStart.disabled = !(currentGame.host_id === profile.id && players.length >= 2);
      }
    }

    displayCode.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(displayCode.textContent); alert('Copied!'); } catch(e){ alert('Copy failed'); }
    });

    function renderLobbyPlayers() {
      lobbyPlayers.innerHTML = players.map(p => `
        <div class="flex items-center space-x-3">
          <img src="${p.avatar || 'https://placehold.co/64x64/0d0c22/ffffff?text=' + (p.username?.charAt(0)||'P')}" class="w-10 h-10 rounded-full">
          <div>${p.username} ${p.user_id === currentGame?.host_id ? '(Host)' : ''}</div>
        </div>
      `).join('');
      lobbyCount.textContent = `(${players.length})`;
      if (currentGame && profile) {
        btnStart.disabled = !(currentGame.host_id === profile.id && players.length >= 2);
      }
    }

    btnLeave.addEventListener('click', () => leaveGame());
    async function leaveGame() {
      if (!currentGame) { show('main'); return; }
      try {
        await supabase.from('players').delete().eq('game_id', currentGame.id).eq('user_id', profile.id);
      } catch(e) { console.error('leave', e); }
      gameChannels.forEach(ch => ch.unsubscribe());
      gameChannels = [];
      currentGame = null;
      players = [];
      show('main');
    }

    btnStart.addEventListener('click', async () => {
      if (!currentGame || currentGame.host_id !== profile.id) return;
      const settings = currentGame.settings;
      await supabase.from('games').update({ state: 'in_progress', current_question: 0, timer_value: settings.timePerQuestion }).eq('id', currentGame.id);
    });

    btnCreate.addEventListener('click', createGame);
    btnJoin.addEventListener('click', () => show('join'));
    joinBack.addEventListener('click', () => show('main'));
    joinGo.addEventListener('click', async () => {
      const code = joinCodeInput.value.trim();
      if (!code) return alert('Enter code');
      await joinGameByCode(code);
    });

    function showGameScreen(gameRow) {
      currentGame = gameRow;
      show('game');
      renderGameScreen();
    }

    function renderGameScreen() {
      if (!currentGame) return;
      qCounter.textContent = `Q: ${Math.max(0,currentGame.current_question+1)}/${currentGame.settings?.numQuestions ?? 0}`;
      timerDisplay.textContent = currentGame.timer_value ?? currentGame.settings?.timePerQuestion ?? 0;

      const idx = currentGame.current_question;
      const q = currentGame.questions && currentGame.questions[idx] ? currentGame.questions[idx] : null;
      if (!q) { questionText.textContent = 'Waiting...'; answersEl.innerHTML = ''; return; }
      questionText.textContent = q.question;
      const mePlayer = players.find(p => p.user_id === profile.id);
      const myAnswer = mePlayer?.current_answer ?? null;

      answersEl.innerHTML = q.answers.map((ans, i) => {
        let classes = 'answer-btn p-3 rounded border w-full text-left';
        if (currentGame.state === 'round_over') {
          if (i === q.correct) classes += ' correct';
          else if (i === myAnswer) classes += ' incorrect';
        } else if (i === myAnswer) classes += ' bg-blue-200';
        const disabled = (currentGame.state === 'round_over' || myAnswer !== null) ? 'disabled' : '';
        return `<button class="${classes}" data-index="${i}" ${disabled}>${String.fromCharCode(65+i)}) ${ans}</button>`;
      }).join('');

      renderPlayersRow();
      if (currentGame.state === 'in_progress' && currentGame.host_id === profile.id) startHostTimer();
    }

    answersEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-index]');
      if (!btn || !currentGame) return;
      const idx = parseInt(btn.dataset.index, 10);
      const { data: myR } = await supabase.from('players').select('id').eq('game_id', currentGame.id).eq('user_id', profile.id).single();
      if (!myR) return;
      await supabase.from('players').update({ answer: idx }).eq('id', myR.id);
    });

    function renderPlayersRow() {
      playersRow.innerHTML = players.slice(0,4).map(p => {
        const isMe = p.user_id === profile.id;
        const selected = isMe ? 'selected-ring' : '';
        return `
          <div class="glass p-3 rounded text-center ${selected}">
            <div class="avatar-ring mx-auto"><img src="${p.avatar || 'https://placehold.co/64x64/0d0c22/ffffff?text=' + (p.username?.charAt(0)||'P')}" class="avatar-small"></div>
            <div class="mt-2 font-bold">${p.username}</div>
            <div class="font-orbitron text-2xl">${p.score}</div>
          </div>
        `;
      }).join('');
    }

    async function appendChat(username, text) {
      const el = document.createElement('div'); el.className = 'p-1';
      el.innerHTML = `<strong class="text-blue-600">${escapeHtml(username)}:</strong> ${escapeHtml(text)}`;
      chatBox.appendChild(el);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    chatSend.addEventListener('click', async () => {
      if (!chatText.value.trim() || !currentGame) return;
      await supabase.from('chat').insert([{ game_id: currentGame.id, user_id: profile.id, username: profile.username, text: chatText.value }]);
      chatText.value = '';
    });
    chatText.addEventListener('keydown', (e) => { if (e.key === 'Enter') chatSend.click(); });


    function startHostTimer() {
      if (hostTimer) return;
      hostTimer = setInterval(async () => {
        const { data: fresh } = await supabase.from('games').select('id, state, timer_value, settings').eq('id', currentGame.id).single();
        if (!fresh || fresh.state !== 'in_progress') { clearInterval(hostTimer); hostTimer = null; return; }
        const newTime = (fresh.timer_value ?? fresh.settings.timePerQuestion) - 1;
        if (newTime < 0) {
          clearInterval(hostTimer); hostTimer = null;
          await evaluateRound();
        } else {
          await supabase.from('games').update({ timer_value: newTime }).eq('id', fresh.id);
        }
      }, 1000);
    }

    async function evaluateRound() {
      if (!currentGame || profile.id !== currentGame.host_id) return;
      const gid = currentGame.id;
      const { data: gameRow } = await supabase.from('games').select('*').eq('id', gid).single();
      const { data: playersRows } = await supabase.from('players').select('*').eq('game_id', gid);
      if (!gameRow || !playersRows) return;

      const q = gameRow.questions[gameRow.current_question];
      for (const p of playersRows) {
        if (p.answer !== null && p.answer === q.correct) {
          let add = 50 + (gameRow.timer_value * 5);
          await supabase.from('players').update({ score: (p.score||0) + add }).eq('id', p.id);
        }
      }
      await supabase.from('games').update({ state: 'round_over' }).eq('id', gid);
      setTimeout(() => advanceGame(), 3000);
    }

    async function advanceGame() {
      if (!currentGame || profile.id !== currentGame.host_id) return;
      const gid = currentGame.id;
      await supabase.from('players').update({ answer: null }).eq('game_id', gid);

      const { data: gameRow } = await supabase.from('games').select('*').eq('id', gid).single();
      const next = (gameRow.current_question ?? -1) + 1;
      const total = gameRow.settings.numQuestions;

      if (next >= (gameRow.questions?.length ?? total)) {
        const { data: playersRows } = await supabase.from('players').select('*').eq('game_id', gid);
        const sorted = playersRows.slice().sort((a,b)=> (b.score||0) - (a.score||0));
        await supabase.from('games').update({ state: 'finished', winner_id: sorted[0]?.user_id ?? null }).eq('id', gid);
        return;
      }
      await supabase.from('games').update({ state: 'in_progress', current_question: next, timer_value: gameRow.settings.timePerQuestion }).eq('id', gid);
    }

    function showGameOver(gameRow) {
      show('over');
      (async ()=>{
        const { data } = await supabase.from('players').select('*, profiles(username,avatar_url)').eq('game_id', gameRow.id);
        if (!data) return;
        const sorted = data.slice().sort((a,b)=> (b.score||0)-(a.score||0));
        const winner = sorted[0];
        winnerBox.innerHTML = `
          <img src="${winner?.profiles?.avatar_url || 'https://placehold.co/128x128/0d0c22/ffffff?text=?'}" class="w-28 h-28 rounded-full mx-auto mb-2">
          <div class="text-2xl font-bold">${winner?.profiles?.username || 'N/A'} wins!</div>
          <div class="mt-3">Final Scores:</div>
          <div class="mt-2">${sorted.map(p=> `<div class="flex justify-between p-2"><span>${p.profiles?.username || 'Guest'}</span><span>${p.score}</span></div>`).join('')}</div>
        `;
      })();
    }

    backMenu.addEventListener('click', () => {
      if (currentGame) leaveGame();
      show('main');
    });

    // utilities
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function shuffleArray(a){ for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

  </script>
</body>
</html>
