<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HardGuess - Multiplayer Trivia</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #10b981;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #94a3b8;
      --danger: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      background: linear-gradient(135deg, #1e1b4b, #312e81);
      color: var(--light);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    .screen { display: none; }
    .active { display: block; }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;
      background: var(--primary); color: white;
    }
    .btn:hover { background: var(--primary-light); }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary-light); }
    .btn-danger { background: var(--danger); }
    .card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin: 16px 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    h1, h2, h3 { margin-bottom: 16px; }
    h1 { font-size: 2.5rem; text-align: center; background: linear-gradient(to right, var(--secondary), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gray); }
    .avatar.local { box-shadow: 0 0 0 4px var(--secondary); }
    .players { display: flex; flex-wrap: wrap; gap: 16px; margin: 16px 0; }
    .player-card {
      background: rgba(15, 23, 42, 0.7);
      padding: 12px; border-radius: 12px; text-align: center; flex: 1; min-width: 120px;
    }
    .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 24px 0; }
    .option-btn {
      padding: 16px; background: var(--dark); border: 2px solid var(--gray); border-radius: 12px; color: white; cursor: pointer; text-align: left;
    }
    .option-btn:hover { border-color: var(--primary-light); }
    .option-btn.correct { border-color: var(--secondary); background: rgba(16, 185, 129, 0.2); }
    .option-btn.incorrect { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }
    .chat-box {
      height: 200px; overflow-y: auto; border: 1px solid var(--gray); border-radius: 8px; padding: 12px; margin: 16px 0;
      display: flex; flex-direction: column-reverse;
    }
    .chat-message { margin-bottom: 8px; }
    .timer { font-size: 1.5rem; color: var(--secondary); font-weight: bold; text-align: center; margin: 16px 0; }
    .code-display { font-size: 2rem; font-weight: bold; letter-spacing: 8px; text-align: center; margin: 16px 0; color: var(--primary-light); }
    table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray); }
    input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--gray); background: var(--dark); color: white; }
    .hidden { display: none; }
    .winner { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
      <div class="card">
        <h1>HardGuess</h1>
        <p>Log in with Google to start playing with your friends!</p>
        <div id="g_id_onload"
             data-client_id="29889911756-eq601p0tlo2turb1amcjbcbpnersi9c4.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
      </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen" class="screen">
      <div class="card">
        <h2>Welcome, <span id="username-display">Player</span>!</h2>
        <button id="create-game-btn" class="btn">Create Game</button>
        <button id="join-game-btn" class="btn btn-outline">Join Game</button>
        <button id="leaderboard-btn" class="btn btn-outline">Leaderboard</button>
        <button id="settings-btn" class="btn btn-outline">Settings</button>
      </div>
    </div>

    <!-- Join Game Screen -->
    <div id="join-screen" class="screen">
      <div class="card">
        <h2>Join a Game</h2>
        <input type="text" id="game-code-input" placeholder="Enter 6-digit code" maxlength="6" />
        <button id="join-submit-btn" class="btn">Join</button>
        <button id="back-to-lobby-join" class="btn btn-outline">Back</button>
      </div>
    </div>

    <!-- Create Game Screen -->
    <div id="create-screen" class="screen">
      <div class="card">
        <h2>Create a Game</h2>
        <label>Seconds per question: <input type="number" id="time-per-question" value="10" min="5" max="60" /></label>
        <label>Eliminate after how many questions? (0 for no elimination): <input type="number" id="elim-after" value="5" min="0" max="20" /></label>
        <button id="create-submit-btn" class="btn">Create & Share Code</button>
        <button id="back-to-lobby-create" class="btn btn-outline">Back</button>
      </div>
    </div>

    <!-- Waiting Room Screen -->
    <div id="waiting-screen" class="screen">
      <div class="card">
        <h2>Waiting for Players...</h2>
        <p>Share this code with your friends:</p>
        <div id="game-code-display" class="code-display">------</div>
        <div id="players-list-waiting" class="players"></div>
        <button id="start-game-btn" class="btn hidden">Start Game</button>
        <button id="leave-game-btn" class="btn btn-outline">Leave</button>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
      <div class="card">
        <div class="timer" id="timer-display">10s</div>
        <h2 id="question-text">Loading question...</h2>
        <div id="options-container" class="options"></div>
        <div class="players" id="players-list-game"></div>
      </div>
      <div class="card">
        <h3>Chat</h3>
        <div id="chat-box" class="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Type a message..." maxlength="100" />
        <button id="send-chat-btn" class="btn btn-outline">Send</button>
      </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <div class="card">
        <h1 id="winner-message" class="winner">Player Wins!</h1>
        <h2>Final Scores</h2>
        <div id="final-scores-list" class="players"></div>
        <button id="play-again-btn" class="btn">Play Again</button>
        <button id="back-to-lobby-results" class="btn btn-outline">Back to Lobby</button>
      </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard-screen" class="screen">
      <div class="card">
        <h2>Leaderboard</h2>
        <p>(Top 5 players by wins)</p>
        <table>
          <thead>
            <tr><th>Rank</th><th>Player</th><th>Wins</th></tr>
          </thead>
          <tbody id="leaderboard-body">
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
        <button id="back-to-lobby-lb" class="btn btn-outline">Back</button>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="screen">
      <div class="card">
        <h2>Settings</h2>
        <h3>Game Rules</h3>
        <ul>
          <li>Host creates a game and shares the 6-digit code.</li>
          <li>Up to 4 players can join.</li>
          <li>Host configures time & elimination.</li>
          <li>Questions are managed in your Supabase `questions` table.</li>
          <li>Avatars require a public `avatars` bucket in Supabase Storage.</li>
        </ul>
        <button id="close-settings-btn" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- ✅ FIXED: Supabase + Google callback in correct order -->
  <script>
  // ✅ 1. Define the Google callback FIRST, as a global function
  window.handleCredentialResponse = null;
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  // ✅ 2. Initialize Supabase
  const supabaseUrl = 'https://kldsmwvljwnosjmvehoq.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsZHNtd3Zsandub3NqbXZlaG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTA3MDYsImV4cCI6MjA3NTE4NjcwNn0.MR28bfvXNmg6RRKFXNxyO2abJVIvgkNoZ7Baib-AOEQ';
  const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  // ✅ 3. NOW assign the actual function to the global callback
  window.handleCredentialResponse = async (response) => {
    try {
      const { error } = await supabase.auth.signInWithIdToken({
        provider: 'google',
        token: response.credential
      });
      if (error) throw error;
      window.location.reload(); // Refresh to enter app
    } catch (err) {
      console.error('Login failed:', err);
      alert('Login failed. Please try again.');
    }
  };

    // Global state
    let currentUser = null;
    let currentGame = null;
    let currentChannel = null;
    let timerInterval = null;

    const screens = {
      login: document.getElementById('login-screen'),
      lobby: document.getElementById('lobby-screen'),
      join: document.getElementById('join-screen'),
      create: document.getElementById('create-screen'),
      waiting: document.getElementById('waiting-screen'),
      game: document.getElementById('game-screen'),
      results: document.getElementById('results-screen'),
      leaderboard: document.getElementById('leaderboard-screen'),
      settings: document.getElementById('settings-modal')
    };

    function showScreen(name) {
      Object.values(screens).forEach(el => el.classList.remove('active'));
      screens[name].classList.add('active');
    }

    // Check auth on load
    async function initApp() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        const { data: profile } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', currentUser.id)
          .single();

        document.getElementById('username-display').textContent = 
          profile?.username || currentUser.email.split('@')[0];
        showScreen('lobby');
      } else {
        showScreen('login');
      }
    }

    // Generate 6-digit game code
    function generateGameCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Load leaderboard
    async function loadLeaderboard() {
      const { data, error } = await supabase
        .from('high_scores')
        .select('*')
        .order('games_won', { ascending: false })
        .limit(5);

      const tbody = document.getElementById('leaderboard-body');
      if (error || !data?.length) {
        tbody.innerHTML = `<tr><td colspan="3">No data yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map((row, i) => 
        `<tr><td>${i+1}</td><td>${row.username || 'Anonymous'}</td><td>${row.games_won || 0}</td></tr>`
      ).join('');
    }

    // Event Listeners
    document.getElementById('settings-btn').onclick = () => showScreen('settings');
    document.getElementById('close-settings-btn').onclick = () => showScreen('lobby');

    document.getElementById('leaderboard-btn').onclick = async () => {
      await loadLeaderboard();
      showScreen('leaderboard');
    };
    document.getElementById('back-to-lobby-lb').onclick = () => showScreen('lobby');

    document.getElementById('join-game-btn').onclick = () => showScreen('join');
    document.getElementById('back-to-lobby-join').onclick = () => showScreen('lobby');

    document.getElementById('create-game-btn').onclick = () => showScreen('create');
    document.getElementById('back-to-lobby-create').onclick = () => showScreen('lobby');

    document.getElementById('join-submit-btn').onclick = async () => {
      const code = document.getElementById('game-code-input').value.trim().toUpperCase();
      if (!code || code.length !== 6) {
        alert('Please enter a valid 6-digit code.');
        return;
      }

      const { data, error } = await supabase
        .from('games')
        .select('id, host_id, settings')
        .eq('game_code', code)
        .eq('status', 'waiting')
        .single();

      if (error || !data) {
        alert('Invalid or expired game code.');
        return;
      }

      await supabase.from('players').insert({ game_id: data.id, user_id: currentUser.id });
      currentGame = { id: data.id, code, host_id: data.host_id, settings: data.settings };
      document.getElementById('game-code-display').textContent = code;
      showScreen('waiting');
      subscribeToGame(data.id);
    };

    document.getElementById('create-submit-btn').onclick = async () => {
      const timePerQ = parseInt(document.getElementById('time-per-question').value) || 10;
      const elimAfter = parseInt(document.getElementById('elim-after').value) || 0;
      const code = generateGameCode();

      const { data, error } = await supabase
        .from('games')
        .insert({
          game_code: code,
          host_id: currentUser.id,
          settings: { time_per_question: timePerQ, eliminate_after: elimAfter }
        })
        .select()
        .single();

      if (error) {
        alert('Failed to create game.');
        return;
      }

      await supabase.from('players').insert({ game_id: data.id, user_id: currentUser.id });
      currentGame = { id: data.id, code, host_id: currentUser.id, settings: data.settings };
      document.getElementById('game-code-display').textContent = code;
      showScreen('waiting');
      subscribeToGame(data.id);
    };

    async function subscribeToGame(gameId) {
      if (currentChannel) supabase.removeChannel(currentChannel);

      currentChannel = supabase
        .channel(`game-${gameId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'players'
        }, (_) => updatePlayerList(gameId))
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'games'
        }, (payload) => {
          if (payload.new.status === 'active') {
            startGame(payload.new);
          }
        })
        .subscribe();

      await updatePlayerList(gameId);
      document.getElementById('start-game-btn').classList.toggle('hidden', currentUser.id !== currentGame.host_id);
    }

    async function updatePlayerList(gameId) {
      const { data } = await supabase
        .from('players')
        .select(`
          user_id,
          score,
          is_eliminated,
          profiles(username, avatar_url)
        `)
        .eq('game_id', gameId)
        .order('created_at', { ascending: true });

      const playerDivs = (data || []).map(p => {
        const isLocal = p.user_id === currentUser.id;
        const username = p.profiles?.username || p.user_id.substring(0, 8);
        const avatar = p.profiles?.avatar_url || `https://api.dicebear.com/7.x/bottts/svg?seed=${p.user_id}`;
        return `
          <div class="player-card">
            <img src="${avatar}" class="avatar ${isLocal ? 'local' : ''}" />
            <div>${username}</div>
            <div>Score: ${p.score}</div>
            ${p.is_eliminated ? '<div style="color:var(--danger)">ELIMINATED</div>' : ''}
          </div>`;
      }).join('');

      document.getElementById('players-list-waiting').innerHTML = playerDivs;
      document.getElementById('players-list-game').innerHTML = playerDivs;
    }

    document.getElementById('start-game-btn').onclick = async () => {
      const { data: questions } = await supabase.from('questions').select('id');
      if (!questions?.length) {
        alert('No questions available. Add some in your Supabase table.');
        return;
      }
      const shuffled = questions.sort(() => 0.5 - Math.random()).map(q => q.id);
      await supabase
        .from('games')
        .update({ status: 'active', question_ids: shuffled, current_question_index: 0 })
        .eq('id', currentGame.id);
    };

    document.getElementById('leave-game-btn').onclick = () => {
      if (currentChannel) supabase.removeChannel(currentChannel);
      showScreen('lobby');
    };

    async function startGame(gameData) {
      showScreen('game');
      loadQuestion(gameData);
    }

    async function loadQuestion(gameData) {
      clearInterval(timerInterval);
      const qIndex = gameData.current_question_index;
      const qId = gameData.question_ids[qIndex];
      const { data: question } = await supabase
        .from('questions')
        .select('*')
        .eq('id', qId)
        .single();

      if (!question) {
        alert('Question not found!');
        return;
      }

      document.getElementById('question-text').textContent = question.question_text;
      const optionsHtml = question.options.map((opt, i) => 
        `<button class="option-btn" data-index="${i}">${opt}</button>`
      ).join('');
      document.getElementById('options-container').innerHTML = optionsHtml;

      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.onclick = () => submitAnswer(btn.dataset.index, question.correct_answer_index);
      });

      let timeLeft = currentGame.settings.time_per_question || 10;
      document.getElementById('timer-display').textContent = `${timeLeft}s`;
      timerInterval = setInterval(async () => {
        timeLeft--;
        document.getElementById('timer-display').textContent = `${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          await advanceGame(gameData);
        }
      }, 1000);
    }

    async function submitAnswer(selectedIndex, correctIndex) {
      if (document.querySelector('.option-btn.correct')) return;

      const isCorrect = parseInt(selectedIndex) === correctIndex;
      const btn = document.querySelector(`.option-btn[data-index="${selectedIndex}"]`);
      btn.classList.add(isCorrect ? 'correct' : 'incorrect');
      if (!isCorrect) return;

      // Update score via RPC (you can create this function in Supabase SQL)
      await supabase.from('players')
        .update({ score: supabase.raw('score + 1') })
        .match({ game_id: currentGame.id, user_id: currentUser.id });

      clearInterval(timerInterval);
      const { data: updatedGame } = await supabase.from('games').select().eq('id', currentGame.id).single();
      await advanceGame(updatedGame);
    }

    async function advanceGame(gameData) {
      const nextIndex = gameData.current_question_index + 1;
      const total = gameData.question_ids.length;

      if (nextIndex >= total) {
        endGame();
        return;
      }

      await supabase
        .from('games')
        .update({ current_question_index: nextIndex })
        .eq('id', currentGame.id);
    }

    async function endGame() {
      const { data } = await supabase
        .from('players')
        .select(`
          user_id,
          score,
          profiles(username)
        `)
        .eq('game_id', currentGame.id)
        .order('score', { ascending: false });

      const winner = data[0];
      const winnerName = winner.profiles?.username || winner.user_id.substring(0, 8);
      document.getElementById('winner-message').textContent = `${winnerName} Wins!`;

      const scoresHtml = data.map(p => {
        const name = p.profiles?.username || p.user_id.substring(0, 8);
        return `
          <div class="player-card">
            <div>${name}</div>
            <div>Score: ${p.score}</div>
          </div>`;
      }).join('');
      document.getElementById('final-scores-list').innerHTML = scoresHtml;

      // Increment win count
      if (winner.user_id === currentUser.id) {
        await supabase.from('profiles')
          .update({ games_won: supabase.raw('games_won + 1') })
          .eq('id', currentUser.id);
      }

      showScreen('results');
    }

    document.getElementById('back-to-lobby-results').onclick = () => showScreen('lobby');
    document.getElementById('play-again-btn').onclick = () => showScreen('lobby');

    // Initialize
    initApp();
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
